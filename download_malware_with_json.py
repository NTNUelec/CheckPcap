import requests
import time
import json
import os
import csv

# our library
from config import *

csv_file_name = "malware_md5.csv"
save_folder = "not_analysis/"
virus_total_api_key = ""
url_download = 'https://www.virustotal.com/vtapi/v2/file/download'
url_report = 'https://www.virustotal.com/vtapi/v2/file/report'

def get_hash_list():
	hash_value_set = set()
	
	with open(csv_file_name) as csvfile:   
		rows = csv.reader(csvfile)
      
		for i, md5_value in enumerate(rows):
			if i == 0:
				continue
			
			hash_value_set.add(str(md5_value[0]))
			
	return hash_value_set


if os.path.isdir("malware_jsons/") == False:
	os.mkdir("malware_jsons/")
if os.path.isdir(save_folder) == False:
	os.mkdir(save_folder)

# get alrady exist json file names
alrady_exist_json_file_names = os.listdir("malware_jsons/")
alrady_exist_hash_value_set = set()
for alrady_exist_json_file_name in alrady_exist_json_file_names:
	 alrady_exist_hash_value_set.add(alrady_exist_json_file_name[:-5])

hash_value_set = get_hash_list()

i = 1	
for hash_value in hash_value_set:
	if hash_value in alrady_exist_hash_value_set:
		continue
		
    params = {'apikey': virus_total_api_key, 'resource': hash_value}
    response = requests.get(url_report, params=params)
    res_json=response.json()

    if(res_json['response_code'] != 0):
        malware_json = {}
        malware_json['md5'] = hash_value
        malware_json['testing_time'] = time.strftime("%Y-%m-%d %H:%M:%S", time.localtime())
    	
    	
        detected_num = 0
        for antivirus in list(res_json['scans'].values()):
            if antivirus['detected']:
                detected_num = detected_num + 1
        malware_json['virus_info'] = {'detected_num':detected_num, 'scan_date':res_json['scan_date']}        

        json_name = hash_value + ".json"
        with open("malware_jsons/" + json_name, 'w') as fout:
            json.dump(malware_json, fout)

        params = {'apikey': virus_total_api_key, 'hash': hash_value}    
        response = requests.get(url_download, params = params)    
        downloaded_file = response.content
    
        if len(downloaded_file) > 0:        
            save_filename = save_folder + hash_value.strip()+".exe"
            fp = open(save_filename, "wb")
            fp.write(downloaded_file)
            fp.close() 
    else:
        print("can't find: " + str(hash_value))     
        


    print(str(i) + "/" + str(len(hash_value_set)))
    i = i+1












